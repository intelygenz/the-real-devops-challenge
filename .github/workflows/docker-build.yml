name: Docker build
on:
    pull_request:
    push:
        branches:
            - master
env:
    DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
    DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}
jobs:
    build:
        runs-on: ubuntu-20.04
        strategy:
          matrix:
            python-version: ['3.6']

        steps:
          - name: Checkout code
            uses: actions/checkout@v3

          - name: Set up Python ${{ matrix.python-version }}
            uses: actions/setup-python@v4
            with:
              python-version: ${{ matrix.python-version }}
            
          - name: Install dependecies
            run: |
              python -m pip install --upgrade pip
              python -m pip install tox tox-gh-actions

          - name: Test with tox
            run: tox -c ./App/tox.ini 
          - name: Login to Docker hub
            uses: docker/login-action@v2
            with:
              username: ${{ env.DOCKER_USERNAME }}
              password: ${{ env.DOCKER_PASSWORD }}

          - name: Build Docker image
            run: |
              docker build -t intelygenz:latest ./app/
              docker build -t mongodb:latest    ./database/

          - name: Push Docker image
            run: |
              docker tag intelygenz:latest ${{ env.DOCKER_USERNAME }}/intelygenz:latest
              docker push ${{ env.DOCKER_USERNAME }}/intelygenz:latest
              docker tag mongodb:latest ${{ env.DOCKER_USERNAME }}/mongodb:latest
              docker push ${{ env.DOCKER_USERNAME }}/mongodb:latest